# Опис

Відео демонстрація:

[![IMAGE ALT TEXT HERE](https://img.youtube.com/vi/MiOdIXQ3F5w/0.jpg)](https://www.youtube.com/watch?v=MiOdIXQ3F5w)

На цьому ресурсі викладено модифіковану прошивку INAV 6.0 з можливістю навігаціі за умов **тимчасової** відсутності GPS.
Працює лише на літаках.
Основна мета модифікації - **повернення літака домому в умовах втрати сигналів керування та GPS**.


Літак повинен бути обладнаний датчиками:
- **акселерометр, гіроскоп**
- **барометр**
- **GPS**
- **компас**
- *трубка піто* (не обов'язково)


Наявна прошивка INAV **відключає всі навігаційні режими** при втраті GPS сигналу. При польотах над недоступною місцевістю, втрата сигналу керування означає втрату літака, оскільки літак може лише або продовжувати безконтрольно летіти, або приземлитися.

Модифікована прошивка дозволяє повернути літак, вікористовуючи лише компас і барометр.

Треба наголосити, що прошивка **не є рішенням для виконання місій в умовах повної відсутності GPS**. Якщо повернення додому з похибкою +-2км для відновлення сигналу керування є нормальним, то виконання місій з такою похибкою навряд чи є доцільним.

**Начасі прошивка протестована лише в симуляторі!!!** https://github.com/RomanLut/INAV-X-Plane-HITL

# Завантаження

### Версія: 1.0

Прошивку можна завантажити тут https://github.com/RomanLut/inav/tree/6.0.0_gps_fix_estimation/firmware

або самостійно зібрати з branch https://github.com/RomanLut/inav/tree/6.0.0_gps_fix_estimation


### Історія змін

* 1.0 Перша робоча версія на основі INAV 6.0


# Як це працює ?

За нормальних умов, літак отримує своє положення від датчика GPS, що надає йому можливість здійснювати навігацію згідно маршруту.

За відсутності GPS, літак має інформацію лише про напрямок польоту (від компасу).

Припустивши, що в навігаційних режимах літак рухається з постійною відомою швидкістю, є можливість вираховувати нові координати, використовуючи останні відомі координати, напрямок і швидкість (так званий метод навігації "dead reconing").

Але така навігація не є точною. З часом накопичується істотна похибка. 

Припускається, що літак почне повернення з деяким відхиленням від курсу, після чого сигнали GPS або керування відновляться.

*Первинно літак повинен отримати GPS fix і запям'ятати точку повернення. Тобто зліт в умовах повної відсутності GPS неможливий.*

# Налаштування

Включення навігації без GPS виконується командою CLI:

```set inav_allow_gps_fix_estimation=ON```

Також (дуже важливо) якомога точніше вказати швидкісь літака в режимі CRUZ. Для цього потрібно вивести швидкість на OSD і здійснити тестовий політ. Щоб мінімізувати вплив вітру, потрібно здійснити польоти в протилежних напрямках і вирахувати середнє.

Швидкіть потрібно вказати в см/с. 

Щоб перевести з км/г до см/с, потрібно домножити на 27.77.

Наприклад, 100 км/г = 100 * 27.77 = 2777 см/с

```set fw_reference_airspeed=2777```

*Важливо, щоб в умовах втрати GPS літак летів з вказаною швидкістю. Якщо у вас налаштовано збільшення Cruise Throttle за допомогою стіку, не використовуйте це в моменти відсутності GPS.*

*Якщо встановлена трубка піто, швидкість буде вираховуватись з даних від трубки піто. Точність навігації підвищиться. Також можна використовувати Cruise throttle override без зниження точності*.

Якщо є потреба виконувати місії без сигналу керування, вводимо:

```set failsafe_mission_delay=-1```

**Після введення команд, важливо зберегти налаштування командою:**

```save```

# Відключення датчика GPS з пульта керування

![](Screenshots/gps_off_box.png) 

Ця можливість може використовуватись:
- для тестування навігації без GPS
- для навмисного відключення GPS в умовах GPS спуфінгу

*Відключення працює після того, я літак знайде супутники і зафіксує точку повернення, і лише в режимі ARM.*

*Важливо: якщо GPS координати вже спотворені GPS спуфінгом, неможна використовувати автоматичне повернення додому. Відключення треба робити заздалегіть. При спотворенні GPS координат потрібно вийти з зони спуфінгу на ручному керуванні, отримати правильний GPS fix, і лише після цього використовувати RTH. Після спотворення, відключення має сенс робити тільки для нейтралізації негативного впливу спотворення (спуфінг впливає на навігаційні режими і утримання висоти). Але при цьому є ризик втратити сигнал керування, і втратити літак, який буде повертатись в невідомому напрямку, використовуючи останні спотворені координати.*

# Що включає ця модифікація ?

- INAV 6.0 release
- підтримку симулятора https://github.com/RomanLut/INAV-X-Plane-HITL
- можливість навігаціі за умов тимчасової відсутності GPS
- можливість відключати GPS з пульта управління


# Навіщо це потрібно, Ardupilot давно так може?

Так, і рекомендується використовувати пошивку Ardupilot, яка набагато більше розвинена. Але не всі польотні контролери підтримують Ardupilot. Ця прошивка рекомендується для літаків, які наразі використовують INAV. У будь-якому випадку, краще мати якісь шанси врятувати літак, ніж ніяких.

# Чи є подібне рішення для квадкоптерів ?

Начасі нажаль немає.

# Помилки сенсорів

Навігація без GPS fix можлива лише за умов стабільної роботи сенсорів GPS, Compass та Baro. Серсор GPS повинен працювати і рапортувати 0 супутників, а не зависати через проблеми з залізом. Прошивка не вирішує проблеми "відпадаючих" серсорів через завади по живленню!

# Special thanks

Many thanks to Sergii Sevriugin and Andy White for testing

# Links

INAV HITL, симулятор https://github.com/RomanLut/INAV-X-Plane-HITL
